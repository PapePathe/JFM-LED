<div class="card-container">

  <% if user.manager? %>
  <h4><strong>Emploi du temps de <%= tech.first_name %></strong></h4>
  <% end %>

  <%= month_calendar(start_date_param: :my_date,
   number_of_days: 20,
   partial: 'simple_calendar/month_calendar',
   attribute: :date,
   events: @availabilities.of(tech)) do |date, availabilities| %>

   <div class="date-day"><%= date.day %></div>
   <div class="cell-content">
    <div class="btn-container">
      <% availabilities.sort_by(&:half).reverse!.each do |availability| %>

      <div class="btn-calendar btn-calendar-<%= availability.status %>" data-availability-id="<%= availability.id %>" >

        <% if user.technician? %>
        <% if availability.booking_id.nil? %>
        <%= availability.status %>
        <% else %>
        <%= availability.booking.user.company.name %>
        <%= availability.booking.address1 %> <%= availability.booking.city %>
        <%= link_to(content_tag(:i, nil, class: 'fa card-icon fa-eye'), technician_booking_path(availability.booking_id))%>
        <% end %>

        <% elsif user.manager? %>
        <% if availability.booking_id.nil? %>
        <%= availability.status %>
        <%= simple_form_for([user.role, availability]) do |f| %>
        <%= f.hidden_field :user_id, value: tech.id %>
        <% if availability.free? %>
        <%= f.hidden_field :status, value: "leave" %>
        <%= f.button :button, class: 'small-icon' do %>
        <i class="fa fa-refresh small-icon" aria-hidden="true"></i>
        <% end %>
        <% else %>
        <%= f.hidden_field :status, value: "free" %>
        <%= f.button :button, class: 'small-icon' do %>
        <i class="fa fa-refresh small-icon" aria-hidden="true"></i>
        <% end %>
        <% end %>
        <% end %>

        <% else %>
        <%= link_to manager_booking_path(availability.booking_id) do %>
        <div class="calendar-card">
          <%= cl_image_tag availability.booking.user.company.photo.public_id, height: 50, width: 50, crop: :pad, class: "card-logo" %>
          <p><%= availability.booking.city %></p>
        </div>
        <% end %>
        <% end %>
        <% end %>

      </div>

      <% end %>

      <!-- Si il n'y a pas d'availability -->
      <% if availabilities.select { |av| av[:half] == "matin" }.empty? && date.future? %>
      <div class="btn-calendar">
        <%= simple_form_for([user.role, Availability.new]) do |f| %>
        <%= f.hidden_field :user_id, value: tech.id %>
        <%= f.hidden_field :date, value: date %>
        <%= f.hidden_field :half, value: "matin" %>
        <%= f.button :button, class: 'small-icon' do %>
        <i class="fa fa-plus small-icon" aria-hidden="true"></i>
        <% end %>
        <% end %>
      </div>
      <% end %>
      <% if availabilities.select { |av| av[:half] == "aprem" }.empty? && date.future? %>
      <div class="btn-calendar">
        <%= simple_form_for([user.role, Availability.new]) do |f| %>
        <%= f.hidden_field :user_id, value: tech.id %>
        <%= f.hidden_field :date, value: date %>
        <%= f.hidden_field :half, value: "aprem" %>
        <%= f.button :button, class: 'small-icon' do %>
        <i class="fa fa-plus small-icon" aria-hidden="true"></i>
        <% end %>
        <% end %>
      </div>
    </div>
    <% end %>
  </div>
  <% end %>
</div>

